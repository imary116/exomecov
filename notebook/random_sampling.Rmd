---
title: "Random sampling of cram files"
author: "Mary T. Yohannes"
date: "4/8/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tools)
```

# 1a) read in table with SCHEMA CRAM paths, sample IDs, and capture (SCZ manifest)
```{r}
ds <- read.csv('~/Desktop/Broad/tj/exomecov/data/2021-03-31_gnomad_scz-exome-manifest.txt', sep = "\t", header=T)
```

# 1b) filter on "primary_disease" column to only "Schizophrenia" patients 
```{r}
SCZ_ds <- ds %>% filter(primary_disease == "Schizophrenia") # 21376 samples 
```

# 1c) from the subsetted dataset of "Schizophrenia" patients, extract the unique PDOs 
```{r}
SCZ_pdo <- distinct(SCZ_ds, pdo) # 41 unique PDOs 
```

# 1d) filter original table to samples with the unique SCZ PDOs 
```{r}
ds_filtered_by_pdo <- ds %>% filter(pdo %in% SCZ_pdo$pdo) # 44250 samples 

# sanity check 
#table(ds_filtered_by_pdo$pdo %in% SCZ_pdo$pdo)
```

# 1e) filter to file paths that end with .cram 
```{r}
cram_filtered_by_pdo <- subset(ds_filtered_by_pdo,grepl("^.+(.cram)$",cram)) # 28066 samples with .cram path extension 

# number of files paths with extensions other than .cram - 16184 samples in total 
#not_cram_filtered_by_pdo <- subset(ds_filtered_by_pdo,!grepl("^.+(.cram)$",cram)) # 16184 samples in total 
### later work: change these extensions to .cram and see which ones I have access to and can run the analysis on  
```

# 1f) Since I didn't have access to all of the files in the orignal table, prior to running the steps above, I filtered out all sample paths with .cram extension (33182) and separated them into ones I have access to and ones I don't have access to using a python script - took 13 hours and 53 minutes to run on my local computer. So instead of running the python script again on the paths obtained in 1e, I decided to filter the paths from 1e using the results from the python script (this is to see which samples, from SCZ unique pdo samples, I had access to and which ones I didn't)
```{r}
# for all files in the original table with .cram extension 
access_paths <- read.table('~/Desktop/Broad/tj/exomecov/data/access_paths.txt') # I have access to 26825 sample paths  
no_access_paths <- read.table('~/Desktop/Broad/tj/exomecov/data/no_access_paths.txt') # 6357 sample paths with no access 

# for SCZ unique pdo samples - subset of the original dataset 
access_filtered_by_pdo <- cram_filtered_by_pdo %>% filter(cram %in% access_paths$V1) # 21745 samples with access 
no_access_filtered_by_pdo <- cram_filtered_by_pdo %>% filter(cram %in% no_access_paths$V1) # 6321 samples with no access 

# sanity check - all samples with .cram extension obtained from the unique SCZ pdos were included in the cram_paths.txt file (the access python script was run on this file) 
#nrow(access_filtered_by_pdo) + nrow(no_access_filtered_by_pdo) == nrow(cram_filtered_by_pdo)

#distinct(no_access_filtered_by_pdo, pdo) # pdos with no access 
# PDO-7055 (buckets of this PDO do not exist), PDO-10439, PDO-11912, PDO-8917, PDO-14779, PDO-17976, PDO-10544, PDO-9490, PDO-9436		
```

# 1g) save the no_access cram paths so you can email it to Christina and ask for access 
```{r}
write.csv(no_access_filtered_by_pdo,"~/Desktop/Broad/tj/exomecov/data/no_access_SCZ_pdo.csv", row.names = FALSE)
```

# 2a) randomly select 100 cram file paths you have access to for the depth and merge analyses 
```{r}
# how many pdos are accessible? 
#unique(access_filtered_by_pdo[c("pdo")]) # OR distinct(access_filtered_by_pdo, pdo) # 18 pdos 

# extract 100 samples at random - creates one whole file that has everything 
set.seed(123) # for reproducibility
samples_per_group <- 100 

# for pdos with <100 samples, include everything 
subsample <- access_filtered_by_pdo %>%
  group_by(pdo) %>%
  slice(sample(n(), min(samples_per_group, n()))) 

#group_keys(subsample) # print out the groups
#count(subsample) # how many samples per group/pdo? 

# sanity check 
#sum(count(subsample)$n) == nrow(subsample)

# split the whole file into individual data frames (per pdo) - 18 data frames in total 
pdo_subsample <- group_split(subsample)

# extract only the cram paths for each group/data frame/pdo 
for (n in seq(nrow(group_keys(subsample))))
{
  group = group_keys(subsample)$pdo
  assign(group[n], pdo_subsample[[n]] %>% select(cram))
}
```

# 2b) save the paths of samples in each pdo group to individual txt files (one txt file per group - total 18 txt files) - the mosdepth script is run on these files 
```{r}
for (i in group_keys(subsample)$pdo)
{
  write.table(get(i),paste0("~/Desktop/Broad/tj/exomecov/data/sampled100_per_pdo/sampled100_", i, ".txt"), row.names=FALSE, col.names=FALSE)
}
```

# 2c) for annotation purposes for later 
```{r}
# table with cram paths and pdo column  
grouped_subsample_cram <- subsample %>% select(cram) # extract only the cram file paths and pdo group membership 

# add sample ID as a column for annotation later 
grouped_subsample_cram$sample_ID <- NA 

# extract the sample ID from the CRAM paths and add them onto their respective rows under sample_ID column 
for (i in 1:nrow(grouped_subsample_cram)) {
  n <- strsplit(grouped_subsample_cram$cram[i], .Platform$file.sep)[[1]][7]
  grouped_subsample_cram$sample_ID[i] <- n
}

# for the PDO "EXTERNAL", the above code returns NA value due to the formatting of the path so there are no sample IDs assigned for those samples in the produced table. For now, we will remove it - work on that later 
grouped_subsample_cram <- grouped_subsample_cram %>% filter(pdo != "EXTERNAL")
#strsplit(strsplit(grouped_subsample_cram$cram[1], .Platform$file.sep)[[1]][6], '\\.')[[1]][2] # trial code: getting the sample IDs for pdo - "EXTERNAL"

# sanity check - 17 pdos 
#distinct(grouped_subsample_cram, pdo)
```

# 2d) write out the file in 2c - pdo, cram paths and sample_ID - tab delimited tsv file without quotes around the string entries 
```{r}
write.table(grouped_subsample_cram,"~/Desktop/Broad/tj/exomecov/data/sampled100_per_pdo/pdo17_crampath_sampleID.tsv",sep="\t",row.names=FALSE, quote=FALSE)
```